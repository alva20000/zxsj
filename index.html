<!DOCTYPE html>
<html>
<head>
  <title>极简组队系统</title>
  <!-- 正确加载依赖 -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.1.15/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.1.15/dist/vuetify.umd.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
  <style>
    /* 添加基础边距 */
    .v-card {
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container>
          <!-- 创建队伍表单 -->
          <v-card class="mb-4">
            <v-card-title>创建新队伍</v-card-title>
            <v-card-text>
              <v-select
                v-model="newParty.dungeon"
                :items="dungeons"
                label="选择副本"
                variant="outlined"
              ></v-select>
              
              <v-combobox
                v-model="newParty.requiredRoles"
                :items="roles"
                label="需求职业"
                multiple
                chips
                variant="outlined"
              ></v-combobox>
              
              <v-btn 
                color="primary"
                @click="createParty"
                :disabled="!canCreate"
              >
                创建队伍
              </v-btn>
            </v-card-text>
          </v-card>

          <!-- 队伍列表 -->
          <v-card 
            v-for="party in sortedParties"
            :key="party.id"
            class="mb-2"
          >
            <v-card-title class="d-flex align-center">
              <v-icon icon="mdi-sword-cross"></v-icon>
              <span class="ml-2">{{ party.dungeon }}</span>
              <v-chip 
                :color="isPartyOpen(party) ? 'green' : 'red'"
                class="ml-2"
              >
                {{ isPartyOpen(party) ? '招募中' : '已满员' }}
              </v-chip>
            </v-card-title>
            
            <v-card-text>
              <div class="mb-2">需求职业：</div>
              <div class="d-flex flex-wrap">
                <v-chip
                  v-for="role in party.requiredRoles"
                  :key="role"
                  class="ma-1"
                  :color="getRoleColor(role)"
                  @click="joinParty(party.id, role)"
                >
                  {{ role }} ({{ countRoles(party.members, role) }}/1)
                </v-chip>
              </div>
              
              <v-divider class="my-3"></v-divider>
              
              <div class="text-caption">
                <v-icon icon="mdi-account-group"></v-icon>
                当前成员：{{ formatMembers(party.members) || '暂无' }}
              </div>
            </v-card-text>
          </v-card>
        </v-container>
      </v-main>
    </v-app>
  </div>

<script>
const firebaseConfig = { /* 你的配置 */ };

// 初始化 Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);

const { createApp } = Vue;

createApp({
  data() {
    return {
      dungeons: ['黑龙巢穴', '熔火之心', '纳克萨玛斯'],
      roles: ['坦克', '治疗', '近战DPS', '远程DPS'],
      newParty: { dungeon: null, requiredRoles: [] },
      parties: []
    }
  },
  computed: {
    sortedParties() {
      return [...this.parties].sort((a, b) => 
        b.timestamp?.seconds - a.timestamp?.seconds
      );
    },
    canCreate() {
      return this.newParty.dungeon && this.newParty.requiredRoles.length > 0;
    }
  },
  methods: {
    // 格式化成员显示
    formatMembers(members) {
      return members.map(m => m.split(':')[1]).join(', ');
    },
    
    // 获取职业颜色
    getRoleColor(role) {
      const colors = {
        '坦克': 'blue',
        '治疗': 'green',
        '近战DPS': 'orange',
        '远程DPS': 'purple'
      };
      return colors[role] || 'grey';
    },

    // 其他方法保持不变...
    async createParty() {
      if (!this.canCreate) return;
      
      await db.collection('parties').add({
        dungeon: this.newParty.dungeon,
        requiredRoles: this.newParty.requiredRoles,
        members: [],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      this.newParty = { dungeon: null, requiredRoles: [] };
    },

    async joinParty(partyId, role) {
      const gameId = prompt(`申请担任 ${role}，请输入游戏ID：`);
      if (!gameId) return;

      const partyRef = db.collection('parties').doc(partyId);
      const party = (await partyRef.get()).data();
      
      if (this.countRoles(party.members, role) < 1) {
        await partyRef.update({
          members: [...party.members, `${role}:${gameId}`]
        });
      }
    },

    countRoles(members, role) {
      return members.filter(m => m.startsWith(role)).length;
    },

    isPartyOpen(party) {
      return party.requiredRoles.some(role => 
        this.countRoles(party.members, role) < 1
      );
    }
  },
  mounted() {
    db.collection('parties').onSnapshot(snapshot => {
      this.parties = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
    });
  }
})
.use(Vuetify.createVuetify())
.mount('#app');
</script>
</body>
</html>